//Place all the behaviors and hooks related to the matching controller here.
// All this logic will automatically be available in application.js.
// You can use CoffeeScript in this file: http://coffeescript.org/
var base_url_regions = "/assets/";
var width = 960,
    height = 500;
$(document).ready(function() {
	stats = Array();
	stats['boroughs'] = gon.feature_groups['boroughs'];

	setup_map();
	plot_data(stats);
})

function plot_data(stats)
{
	var svg = d3.select('#map').select('g');
	console.log(svg);	
	for(var i = 0; i < stats['boroughs'].length; i++)
	{
		var loc_id = stats['boroughs'][i]['locations'];
		var curr_rank = stats['boroughs'][i]['rank'];
		for(var j = 0; j < loc_id.length; j++)
		{
			console.log(loc_id[j]);
			console.log(svg.select('[boro-id="' + loc_id[j] + '"]').classed("rank-" + curr_rank, true));
		}
	}
}

//dfkndsjnj

function setup_map()
{

	var path = d3.geo.path()
	    .projection(null);

	var svg = d3.select("#map");

	d3.json(base_url_regions + "london_topo.json", function(error, london) {
	  console.log(london);
	  //var subunits = 
	  console.log(london.objects);

	  var features = svg.append("g");

	  var boroughs = topojson.feature(london, london.objects.londonTrimmed);
	  var wards = topojson.feature(london, london.objects.londonWardsTrimmed);
	  console.log(boroughs);

	   var zoom = d3.behavior.zoom()
	      .translate([0, 0])
	      .scale(1)
	      .scaleExtent([1, 8])
	      .on("zoom", zoomed);

	  var projection = d3.geo.albers()
	    .center([0, 51.4])
	    .rotate([-0.12, 0])
	    .parallels([50, 60])
	    .scale(75000)
	    .translate([width / 2, height / 2]);


	  var path = d3.geo.path()
	    .projection(projection);

	  features.append("path")
	    .datum(boroughs)
	    .attr("d", path);


	  features.selectAll(".boroughs")
	    .data(topojson.feature(london, london.objects.londonTrimmed).features)
	  .enter().append("path")
	  	.attr("boro-id", function(d){
	  		return d['id'];
	  	})
	    .attr("d", path);

	    svg.append("rect")
	      .attr("class", "overlay")
	      .attr("width", width)
	      .attr("height", height)
	      .call(zoom);


	    function zoomed() {
	      features.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	    }
		});

	d3.select(self.frameElement).style("height", height + "px");
}
//Resizes the map after a short delay.
window.onresize = function()
{
 setTimeout( 
  	function() { 
      	$('.street_map .map-container').css('height', $(window).height() * 0.8);

  	}, 
    200);
}



//Hellosadsads