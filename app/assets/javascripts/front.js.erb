//Place all the behaviors and hooks related to the matching controller here.
// All this logic will automatically be available in application.js.
// You can use CoffeeScript in this file: http://coffeescript.org/

var globalMap;
var globalLayers = [];
var base_url_regions = "/assets/";
$(document).ready(function (){
    var fromProjection  = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
    var toProjection    = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection

    globalMap = intialise_map();

    //Initialise styles, rules and layers
    var style_array = setup_styles();
    var borough_fill_style = style_array['borough_fill_style'];
    var ward_fill_style = style_array['ward_fill_style'];
    var ward_select_style = style_array['ward_select_style'];

    var loaded_region_data = []

    console.log(gon.feature_groups);



    //Initialise and add rules
    var rule_array = setup_rules(gon.feature_groups['boroughs'].length);
    for(i in rule_array)
    {
    	borough_fill_style.addRules([rule_array[i]]);
    }

    
    //Initialise and store layer objects
    var layers = setup_layers(globalMap, borough_fill_style, ward_fill_style, ward_select_style);
    var borough_layer = layers['borough_layer'];
    globalLayers['borough_layer'] = borough_layer;

    var ward_layer = layers['ward_layer'];
    globalLayers['ward_layer'] = ward_layer;

    //Get regions asynchronously and plot on map
    $.ajax({
        url: base_url_regions + "boroughs-reduced.json",
        crossDomain: true,
        dataType: "JSON",
        cache: false
    })
    .done(function( json ) {
        loaded_region_data['boroughs'] = json['regions'];
        plot_features(globalMap, borough_layer, json['regions'], "London Boro", fromProjection, toProjection);
        insert_stats(globalMap, borough_layer, gon.feature_groups['boroughs']);
    });

    $.ajax({
        url: base_url_regions + "wards-reduced.json",
        crossDomain: true,
        dataType: "JSON",
        cache: false
    })
    .done(function( json ) {
        loaded_region_data['wards'] = json['regions'];
        plot_features(globalMap, ward_layer, json['regions'], "Ward", fromProjection, toProjection);
        insert_stats(globalMap, ward_layer, gon.feature_groups['wards']);
    });

    //Set up scroll level controls
    setup_controls(globalMap, ward_layer);

    globalMap.events.register("zoomend", globalMap, zoom_level_changed);

    //This is a hack, and I don't like it, but whatever
    //It's necessary because OpenLayers flatly refuses to load into a % width div
    $('.front .map-container').css('height', $(window).height() * 0.8);
    globalMap.updateSize();
});

function zoom_level_changed()
{
    zoom = globalMap.getZoom();
    console.log(zoom);
    if(zoom <= 12)
    {
        globalLayers['ward_layer'].setVisibility(false);
    }
    else
    {
        globalLayers['ward_layer'].setVisibility(true);
    }
}

//Resizes the map after a short delay.
window.onresize = function()
{
 setTimeout( 
  	function() { 
      	$('.front .map-container').css('height', $(window).height() * 0.8);
        globalMap.updateSize();
  	}, 
    200);
}