//Place all the behaviors and hooks related to the matching controller here.
// All this logic will automatically be available in application.js.
// You can use CoffeeScript in this file: http://coffeescript.org/

var globalMap;
var globalLayers = [];
$(document).ready(function (){
    var fromProjection  = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
    var toProjection    = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection

    //console.log(gon.display_arrays);

    globalMap = intialise_map();

    //Initialise styles, rules and layers
    var style_array = setup_styles();
    var borough_fill_style = style_array['borough_fill_style'];
    var ward_fill_style = style_array['ward_fill_style'];
    var ward_select_style = style_array['ward_select_style'];

    var rule_array = setup_rules(gon.display_arrays.length);
    //borough_fill_style.addRules([rule_array['rule1'], rule_array['rule2'], rule_array['rule3'], rule_array['rule4']]); 
    for(i in rule_array)
    {
    	 borough_fill_style.addRules([rule_array[i]]);
    }

    
    var layers = setup_layers(globalMap, borough_fill_style, ward_fill_style, ward_select_style);
    var borough_layer = layers['borough_layer'];
    globalLayers['borough_layer'] = borough_layer;

    var ward_layer = layers['ward_layer'];
    globalLayers['ward_layer'] = ward_layer;

    _plot_regions(globalMap, borough_layer, gon.display_arrays, "London Boro", fromProjection, toProjection);
    plot_regions(globalMap, ward_layer, gon.wards, "Ward", fromProjection, toProjection);

    setup_controls(globalMap, ward_layer);

    globalMap.events.register("zoomend", globalMap, zoom_level_changed);

    console.log(borough_layer);
    //This is a hack, and I don't like it, but whatever
    //It's necessary because OpenLayers flatly refuses to load into a % width div
    $('.front .map-container').css('height', $(window).height() * 0.8);
    globalMap.updateSize();
});

function zoom_level_changed()
{
    zoom = globalMap.getZoom();
    console.log(zoom);
    if(zoom <= 12)
    {
        globalLayers['ward_layer'].setVisibility(false);
    }
    else
    {
        globalLayers['ward_layer'].setVisibility(true);
    }
}

//Resizes the map after a short delay.
window.onresize = function()
{
 setTimeout( 
  	function() { 
      	$('.front .map-container').css('height', $(window).height() * 0.8);
        globalMap.updateSize();
  	}, 
    200);
}